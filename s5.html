<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>节点转换工具</title>
 
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
            color: #333;
            min-height: 100vh;
            padding: 20px;
            position: relative;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }
        
        header {
            background: linear-gradient(to right, #2c3e50, #4a6491);
            color: white;
            padding: 25px;
            text-align: center;
        }
        
        h1 {
            font-size: 2.2rem;
            margin-bottom: 10px;
        }
        
        .subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        
        .content {
            display: flex;
            flex-wrap: wrap;
            padding: 20px;
        }
        
        .input-section, .preview-section {
            flex: 1;
            min-width: 300px;
            padding: 20px;
        }
        
        .section-title {
            font-size: 1.4rem;
            margin-bottom: 15px;
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 8px;
        }
        
        textarea {
            width: 100%;
            height: 300px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            resize: vertical;
            margin-bottom: 15px;
            background-color: #f9f9f9;
        }
        
        .example {
            background-color: #f0f7ff;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            font-size: 0.9rem;
            line-height: 1.5;
        }
        
        .example-title {
            font-weight: bold;
            margin-bottom: 8px;
            color: #2980b9;
        }
        
        .buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
        }
        
        .parse-btn {
            background-color: #3498db;
            color: white;
        }
        
        .parse-btn:hover {
            background-color: #2980b9;
        }
        
        .download-btn {
            background-color: #2ecc71;
            color: white;
        }
        
        .download-btn:hover {
            background-color: #27ae60;
        }
        
        .copy-btn {
            background-color: #9b59b6;
            color: white;
        }
        
        .copy-btn:hover {
            background-color: #8e44ad;
        }
        
        .preview-area {
            background-color: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 0.9rem;
            line-height: 1.4;
        }
        
        .info {
            margin-top: 15px;
            padding: 10px;
            background-color: #e8f4fc;
            border-radius: 6px;
            font-size: 0.9rem;
        }
        
        .node-count {
            font-weight: bold;
            color: #e74c3c;
        }
        
        .expiry {
            font-weight: bold;
            color: #e67e22;
        }
        
        footer {
            text-align: center;
            padding: 20px;
            background-color: #f1f1f1;
            color: #7f8c8d;
            font-size: 0.9rem;
        }
        
        /* 新增弹窗样式 */
        .toast {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 1.1rem;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .toast.show {
            opacity: 1;
        }
        
        @media (max-width: 768px) {
            .content {
                flex-direction: column;
            }
            
            .input-section, .preview-section {
                width: 100%;
            }
            
            .toast {
                width: 80%;
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>节点转换工具</h1>
            <p class="subtitle">批量转换节点为标准格式，并生成可下载的txt文件</p>
        </header>
        
        <div class="content">
            <div class="input-section">
                <h2 class="section-title">选择五 地区日期格式到期</h2>
                <textarea id="inputText" placeholder=""></textarea>
                
                <div class="example">
                    <div class="example-title">输入格式示例：</div>
                    <p>地址/端口/账号/密码/运营商-地区节点/开始时间/到期时间</p>
                    <p>例如: 123.cc/80/123/123/嘿嘿/2025-09-28 01:59:24/2025-10-28 01:59:24</p>
                </div>
                
                <div class="buttons">
                    <button id="parseBtn" class="parse-btn">解析并预览</button>
                    <button id="downloadBtn" class="download-btn">下载TXT文件</button>
                    <button id="copyBtn" class="copy-btn">复制到剪贴板</button>
                </div>
            </div>
            
            <div class="preview-section">
                <h2 class="section-title">预览输出结果</h2>
                <div id="previewArea" class="preview-area">解析后的结果将显示在这里...</div>
                
                <div class="info">
                    <p>节点数量: <span id="nodeCount" class="node-count">0</span></p>
                    <p>开通时间: <span id="startDate" class="expiry">-</span></p>
                    <p>到期时间: <span id="expiryDate" class="expiry">-</span></p>
                    <p>文件名: <span id="fileName" class="node-count">【0】.txt</span></p>
                </div>
            </div>
        </div>
        
        <footer>
            <p>© 2025 节点转换工具 | 自动识别节点中的到期时间</p>
        </footer>
    </div>

    <!-- 新增弹窗元素 -->
    <div id="toast" class="toast">内容已复制到剪贴板</div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const inputText = document.getElementById('inputText');
            const previewArea = document.getElementById('previewArea');
            const parseBtn = document.getElementById('parseBtn');
            const downloadBtn = document.getElementById('downloadBtn');
            const copyBtn = document.getElementById('copyBtn');
            const nodeCount = document.getElementById('nodeCount');
            const startDate = document.getElementById('startDate');
            const expiryDate = document.getElementById('expiryDate');
            const fileName = document.getElementById('fileName');
            const toast = document.getElementById('toast'); // 新增弹窗元素
            
            // 显示弹窗函数
            function showToast(message) {
                toast.textContent = message;
                toast.classList.add('show');
                
                setTimeout(() => {
                    toast.classList.remove('show');
                }, 2000);
            }
            
            // 获取当前日期时间字符串
            function getCurrentDateTime() {
                const now = new Date();
                const year = now.getFullYear();
                const month = String(now.getMonth() + 1).padStart(2, '0');
                const day = String(now.getDate()).padStart(2, '0');
                const hours = String(now.getHours()).padStart(2, '0');
                const minutes = String(now.getMinutes()).padStart(2, '0');
                
                return `${year}-${month}-${day} ${hours}:${minutes}`;
            }
            
            // 修复时区问题的日期解析函数
            function parseDateWithoutTimezone(dateString) {
                // 直接解析日期部分，忽略时区影响
                const parts = dateString.split('-');
                if (parts.length === 3) {
                    const year = parseInt(parts[0]);
                    const month = parseInt(parts[1]) - 1; // 月份从0开始
                    const day = parseInt(parts[2]);
                    return new Date(year, month, day);
                }
                return new Date(dateString); // 备用方案
            }
            
            // 解析节点信息
            function parseNodes() {
                const input = inputText.value.trim();
                if (!input) {
                    previewArea.textContent = "";
                    nodeCount.textContent = "0";
                    fileName.textContent = "【0】.txt";
                    startDate.textContent = "-";
                    expiryDate.textContent = "-";
                    return;
                }
                
                const lines = input.split('\n').filter(line => line.trim());
                const nodes = [];
                let earliestStart = "";
                let latestExpiry = "";
                
                lines.forEach((line, index) => {
                    const parts = line.split('/');
                    if (parts.length >= 5) {
                        const address = parts[0];
                        const port = parts[1];
                        const username = parts[2];
                        const password = parts[3];
                        const description = parts[4];
                        
                        // 尝试获取开始时间和到期时间
                        let start = "";
                        let expiry = "";
                        const timeFields = [];
                        
                        // 收集所有时间字段
                        for (let i = 0; i < parts.length; i++) {
                            if (parts[i].match(/\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}/)) {
                                timeFields.push(parts[i].split(' ')[0]); // 只取日期部分
                            }
                        }
                        
                        // 如果有两个时间字段，第一个是开始时间，第二个是到期时间
                        if (timeFields.length >= 2) {
                            start = timeFields[0];
                            expiry = timeFields[1];
                        } else if (timeFields.length === 1) {
                            // 如果只有一个时间字段，假设为到期时间
                            expiry = timeFields[0];
                        }
                        
                        // 更新最早开始时间和最晚到期时间
                        if (start) {
                            const startDateObj = parseDateWithoutTimezone(start);
                            const currentEarliest = earliestStart ? parseDateWithoutTimezone(earliestStart) : null;
                            
                            if (!currentEarliest || startDateObj < currentEarliest) {
                                earliestStart = start;
                            }
                        }
                        
                        if (expiry) {
                            const expiryDateObj = parseDateWithoutTimezone(expiry);
                            const currentLatest = latestExpiry ? parseDateWithoutTimezone(latestExpiry) : null;
                            
                            if (!currentLatest || expiryDateObj > currentLatest) {
                                latestExpiry = expiry;
                            }
                        }
                        
                        // 提取地区名称
                        let region = description.split('-')[1] || "";
                        region = region.replace('节点', '').replace('住宅', '');
                        
                        // 判断节点类型：包含"住宅"的为动态，否则为静态
                        const nodeType = description.includes('住宅') ? '动态' : '静态';
                        
                        const nodeInfo = `${index+1}号${region}${nodeType}\n类型选socks5\n地址${address}\n端口${port}\n帐号${username}\n密码${password}\n`;
                        nodes.push(nodeInfo);
                    }
                });
                
                // 如果没有找到开始时间，使用当前时间
                if (!earliestStart) {
                    const now = new Date();
                    earliestStart = now.toISOString().split('T')[0];
                }
                
                // 如果没有找到到期时间，使用开始时间+1个月
                if (!latestExpiry) {
                    const start = parseDateWithoutTimezone(earliestStart);
                    const expiry = new Date(start.getFullYear(), start.getMonth() + 1, start.getDate());
                    latestExpiry = expiry.toISOString().split('T')[0];
                }
                
                const result = nodes.join('\n') + `\n开通时间${earliestStart}\n到期时间${latestExpiry}`;
                
                // 更新文件名显示
                const currentDateTime = getCurrentDateTime();
                fileName.textContent = `【${nodes.length}】${currentDateTime}.txt`;
                
                previewArea.textContent = result;
                nodeCount.textContent = nodes.length;
                startDate.textContent = earliestStart;
                expiryDate.textContent = latestExpiry;
                
                return result;
            }
            
            // 生成并下载TXT文件
            function downloadTxt() {
                const result = parseNodes();
                if (!result || nodeCount.textContent === "0") {
                    showToast("请先输入有效的代理节点信息并解析");
                    return;
                }
                
                const blob = new Blob([result], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                
                // 使用显示的文件名作为下载文件名
                a.download = fileName.textContent;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }
            
            // 复制到剪贴板
            function copyToClipboard() {
                const result = parseNodes();
                if (!result || nodeCount.textContent === "0") {
                    showToast("请先输入有效的代理节点信息并解析");
                    return;
                }
                
                navigator.clipboard.writeText(result).then(() => {
                    showToast("内容已复制到剪贴板");
                }).catch(err => {
                    console.error('复制失败: ', err);
                    // 备用复制方法
                    const textArea = document.createElement('textarea');
                    textArea.value = result;
                    document.body.appendChild(textArea);
                    textArea.select();
                    try {
                        document.execCommand('copy');
                        showToast("内容已复制到剪贴板");
                    } catch (e) {
                        showToast("复制失败，请手动复制预览区域的内容");
                    }
                    document.body.removeChild(textArea);
                });
            }
            
            // 添加粘贴事件监听 - 新增功能
            inputText.addEventListener('paste', function(e) {
                // 让浏览器先完成粘贴操作
                setTimeout(() => {
                    parseNodes();
                }, 10);
            });
            
            // 添加输入事件监听 - 新增功能，实现实时解析
            inputText.addEventListener('input', function() {
                // 添加防抖，避免频繁解析
                clearTimeout(inputText.debounceTimer);
                inputText.debounceTimer = setTimeout(() => {
                    parseNodes();
                }, 500);
            });
            
            // 事件监听
            parseBtn.addEventListener('click', parseNodes);
            downloadBtn.addEventListener('click', downloadTxt);
            copyBtn.addEventListener('click', copyToClipboard);
            
            // 初始示例数据
            inputText.value = "";
            parseNodes();
        });
    </script>
</body>
</html>
